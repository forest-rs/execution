---
id: et-f999
status: closed
deps: [et-2ef3]
links: [et-9e42]
created: 2026-01-31T05:19:28Z
type: task
priority: 2
assignee: Bruce Mitchener
parent: et-8de9
tags: [execution_tape, vm, verifier, perf]
---
# VerifiedProgram fast path (elide pure-op type checks)

Introduce a `VerifiedProgram`-driven execution fast path in the VM that can skip redundant dynamic type checks for pure ops, while still validating host ABI conformance (return arity/types).

## Design

Motivation: verified bytecode already guarantees operand types for pure ops (e.g. `i64_add`), so re-checking tags at runtime is redundant overhead. However, host calls are a trust boundary, so `run_verified` must still validate host returns (and possibly entry args).

Approach:
- Keep `Vm::run` for running arbitrary/untrusted `Program` (retain detailed `TypeMismatch` traps).
- Add `Vm::run_verified(&VerifiedProgram, ...)` that uses a dedicated internal loop (or `RunMode` flag) to:
  - treat unexpected runtime types as VM bug / `InvalidPc` (cold path) rather than constructing detailed `TypeMismatch`;
  - keep runtime-dependent checks (fuel/depth/host-call limits, `array_get` OOB, agg handle validity).
  - validate host return arity/types on every `host_call`; optionally validate entry arg types once at entry.

No unsafe; prefer cold error paths and minimal branching.

## Acceptance Criteria

- `Vm::run_verified` no longer just calls `Vm::run`; it skips redundant type checks for pure ops.
- Host call return arity/types are validated in `run_verified`.
- Tests cover a host returning wrong types under `run_verified`.
- `cargo fmt`/`cargo clippy -D warnings`/`cargo test` pass.


## Notes

**2026-01-31T05:22:21Z**

Created ticket to track `VerifiedProgram` fast-path work: `run_verified` should not just call `run`; it should skip redundant dynamic checks for pure ops while still validating host returns.

**2026-01-31T05:41:30Z**

Implemented `RunMode`-based VM loop: `run_verified` skips redundant dynamic type checks for pure ops (`i64_add`) and aggregate construction element checks, while still validating host return arity/types; added regression test. fmt/clippy/test clean.
