---
id: et-2442
status: closed
deps: []
links: []
created: 2026-01-31T04:27:59Z
type: task
priority: 1
assignee: Bruce Mitchener
parent: et-8de9
tags: [execution_tape, format, verifier, vm, api]
---
# Typed signatures + HostSigId host_call encoding

Make typed function signatures mandatory; add HostTypeId-carrying ValueType and Any; add host signature table and change host_call bytecode encoding to carry HostSigId (table index) instead of (SymbolId,SigHash). Update container format, asm/builder, verifier, vm, and spec docs.


## Notes

**2026-01-31T04:45:47Z**

Implemented typed function signatures (mandatory) + host signature table and switched `host_call` bytecode to `HostSigId`. Added `ValueType::Any` and `ValueType::Obj(HostTypeId)` encoding, updated container version to `0.2`, updated asm/builder + decoder/verifier/vm, and synced `v1_spec.md`. `cargo fmt`/`cargo clippy -D warnings`/`cargo test` pass.

**2026-01-31T04:47:39Z**

**Overview**
- Goal: make type checking and host-call validation *table-driven* and portable.
- Non-goals: backward-compatible decoding/upgrade paths; rich union types; async host calls.

**Concepts + glossary**
- `HostSigId`: bytecode reference to a host signature table entry.
- `host_sigs`: program table mapping `HostSigId -> (SymbolId, SigHash, arg_types, ret_types)`.
- `function_sigs`: typed function signatures (mandatory) stored separately from counts.
- `Any`: explicit “escape hatch” value type (also used as the verifier’s merge-top).
- `Obj(HostTypeId)`: opaque host object with a stable type id.

**Why this shape**
- `HostSigId` in bytecode keeps instructions compact and decode fast (vector indexing), avoids repeating `(symbol_id, sig_hash)` at every callsite, and gives a stable attachment point for future per-signature metadata (cost model, debug name, effect-lane classification).
- Mandatory typed function signatures avoid a long-lived “counts-only” mode that would make the verifier and later tooling ambiguous/harder to migrate once programs exist in the wild.
- `Any` provides a first-class, explicit escape hatch without committing to union types; verifier can propagate `Any` across CFG merges and only error when a typed use requires a concrete type.
- `Obj(HostTypeId)` preserves host-defined identity/type information while keeping VM semantics opaque.

**Usage example (builder intent)**
- Embedder declares a host signature once via `ProgramBuilder::host_sig_for("price.lookup", HostSig { .. })`, gets a `HostSigId`, then emits `host_call` using that id.

**Extension points**
- Add per-`HostSigEntry` metadata (cost/fuel hints, tracing name, effect lane).
- Evolve type lattice beyond `Any` (e.g. unions) if/when needed.

**Gotchas / risks**
- `Any` can mask mistakes if overused; typed op verification should continue to require concrete types unless the opcode explicitly permits `Any`.
- Signature hashing must remain stable; verifier recomputes hashes from canonical type encoding and rejects mismatches.
