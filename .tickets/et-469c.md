---
id: et-469c
status: closed
deps: []
links: []
created: 2026-01-31T04:03:50Z
type: task
priority: 1
assignee: Bruce Mitchener
parent: et-8de9
tags: [execution_tape, bytecode, api]
---
# Asm: span markers, host_call_sig, interning, newtyped ids

Upgrade public assembler/builder: span markers emitted from Asm, host_call helper that hashes HostSig, ProgramBuilder interning (symbols/consts/types), and newtyped IDs (SymbolId/ConstId/TypeId/ElemTypeId) to avoid u32 mixing.


## Notes

**2026-01-31T04:03:55Z**

Implemented: `ProgramBuilder::symbol`/`constant`/`struct_type`/`array_elem` (interning) + newtypes (`SymbolId`/`ConstId`/`TypeId`/`ElemTypeId`), `Asm` span markers via `Asm::span` and `finish_parts`/`finish_checked_parts`, and `Asm::host_call_sig`; updated VM/verifier/decoder accordingly; added tests; fmt/clippy/test pass.

**2026-01-31T04:47:50Z**

**Overview**
- Goal: make authoring bytecode/programs ergonomic and less error-prone (no manual offsets/IDs), while keeping runtime/core crates small.
- Non-goals: a full compiler frontend; optimizing assembly; persistent on-disk interning.

**Concepts + glossary**
- `Asm`: bytecode builder with labels and fixups.
- `Asm::span(span_id)`: records span markers at the current PC.
- `ProgramBuilder`: small helper for assembling a `Program` with interned tables.
- `SymbolId` / `ConstId` / `TypeId` / `ElemTypeId`: newtyped indices to prevent accidental mixing of `u32` ids.

**Why this shape**
- Span markers in the builder avoid hand-constructing `Vec<SpanEntry>` and reduce the chance of invalid `pc_delta` sequences.
- Interning in `ProgramBuilder` (symbols/consts/types) keeps callsites terse and encourages reuse without forcing a global allocator strategy.
- Newtyped ids pay for themselves quickly: they prevent entire classes of mistakes (e.g. passing a const index where a symbol id is expected) with near-zero runtime cost.

**Usage example (builder intent)**
- `let sym = pb.symbol("mesh.make_cube");` (dedups automatically)
- `let c = pb.constant(Const::I64(7));` (dedups automatically)
- `a.const_pool(r1, c);` (cannot accidentally pass a `SymbolId`)

**Extension points**
- Future: pack strings/bytes into arenas (see et-8ab0 / et-090a) without changing public IDs.
- Future: richer builder helpers for typed ops and multi-function modules.

**Gotchas / risks**
- Interning uses linear search today (fine for “hundreds of nodes”/prototype scale). If this becomes hot, switch to a small `hashbrown` map behind an opt-in feature.
